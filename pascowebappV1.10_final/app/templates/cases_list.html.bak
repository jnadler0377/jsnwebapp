
{% extends "base.html" %}
{% block content %}
<h2>Cases</h2>

<form id="bulk-actions" method="post">
  <div style="display:flex; gap: 0.5rem; align-items:center; flex-wrap: wrap; margin: 0.5rem 0;">
    <input type="search" name="case" value="{{ search_query or '' }}" placeholder="Search case #">
    <button type="submit" formaction="/cases" formmethod="get">Search</button>

    <label style="margin-left:1rem;">
      <input type="checkbox" id="show-archived-toggle" {% if show_archived %}checked{% endif %}
             onclick="window.location.href='?page={{ pagination.page }}&show_archived='+(this.checked?1:0){% if search_query %}+'&case={{ search_query }}'{% endif %}">
      Show archived
    </label>

    <button type="submit" formaction="/cases/archive" formmethod="post">Archive Selected</button>
    <button type="submit" formaction="/cases/export" formmethod="post">Export CSV</button>

    <input type="hidden" name="show_archived" value="{{ 1 if show_archived else 0 }}">
    <input type="hidden" name="page" value="{{ pagination.page }}">
  </div>

<style>
  .pagination .btn {
    font-size: 0.7em !important;
    padding: 0.25em 0.5em !important;
  }
  .pagination span {
    font-size: 0.7em !important;
  }
  /* Reduce font size across the table to ~75% of original */
  .table { font-size: 0.75em; }
  /* Make rows look clickable */
  .table tbody tr { cursor: pointer; }
  .table tbody tr:focus { outline: 2px solid #007bff; }
  .table th, .table td { padding: 0.5em; vertical-align: middle; }
</style>

{% if cases %}
  <table class="table">
    <thead>
      <tr>
        <th><input type="checkbox" id="check-all"></th>
        <th>Case #</th>
        <th>Filed</th>
        <th>Style</th>
        <th>Address</th>
      </tr>
    </thead>
    <tbody>
      {% for c in cases %}
      <tr data-href="/cases/{{ c.id }}" tabindex="0" role="link" aria-label="Open case {{ c.case_number }}">
        <td><input type="checkbox" name="ids" value="{{ c.id }}" onclick="event.stopPropagation()"></td>
        <td>{{ c.case_number }}</td>
        <td>{{ c.filing_datetime }}</td>
        <td>{{ c.style }}</td>
        <td>
          {% if c.address_override %}
            {{ c.address_override }}
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

  <!-- Simple pagination -->
  <nav class="pagination" aria-label="Pagination">
    {% if pagination.page > 1 %}
      <a class="btn" href="?page=1&show_archived={{ 1 if show_archived else 0 }}{% if search_query %}&case={{ search_query }}{% endif %}">« First</a>
      <a class="btn" href="?page={{ pagination.page - 1 }}&show_archived={{ 1 if show_archived else 0 }}{% if search_query %}&case={{ search_query }}{% endif %}">‹ Prev</a>
    {% else %}
      <span class="btn disabled">« First</span>
      <span class="btn disabled">‹ Prev</span>
    {% endif %}
    <span>Page {{ pagination.page }} of {{ pagination.pages }}</span>
    {% if pagination.page < pagination.pages %}
      <a class="btn" href="?page={{ pagination.page + 1 }}&show_archived={{ 1 if show_archived else 0 }}{% if search_query %}&case={{ search_query }}{% endif %}">Next ›</a>
      <a class="btn" href="?page={{ pagination.pages }}&show_archived={{ 1 if show_archived else 0 }}{% if search_query %}&case={{ search_query }}{% endif %}">Last »</a>
    {% else %}
      <span class="btn disabled">Next ›</span>
      <span class="btn disabled">Last »</span>
    {% endif %}
  </nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var tbody = document.querySelector('.table tbody');
  if (!tbody) return;
  tbody.addEventListener('click', function(e) {
    var tr = e.target.closest('tr[data-href]');
    if (tr && !(e.target.tagName === 'A' || e.target.closest('a') || e.target.type === 'checkbox')) {
      window.location.href = tr.getAttribute('data-href');
    }
  });
  tbody.addEventListener('keydown', function(e) {
    var tr = e.target.closest('tr[data-href]');
    if (tr && (e.key === 'Enter' || e.key === ' ')) {
      e.preventDefault();
      window.location.href = tr.getAttribute('data-href');
    }
  });

  var checkAll = document.getElementById('check-all');
  if (checkAll) {
    checkAll.addEventListener('change', function() {
      document.querySelectorAll('input[name="ids"]').forEach(function(cb){ cb.checked = checkAll.checked; });
    });
  }
});
</script>

{% else %}
  <p>No cases imported yet. Go to <a href="/import">Update Case List</a>.</p>
{% endif %}
{% endblock %}
